<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OuviDigital - MVP Funcional</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .gradient-bg { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .status-badge { padding: 4px 12px; border-radius: 12px; font-size: 12px; font-weight: 600; }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Header -->
    <header class="gradient-bg text-white shadow-lg">
        <div class="container mx-auto px-4 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-3">
                    <i class="fas fa-headset text-3xl"></i>
                    <div>
                        <h1 class="text-2xl font-bold">OuviDigital MVP</h1>
                        <p class="text-sm opacity-90">Sistema Funcional com Backend</p>
                    </div>
                </div>
                <div id="status-backend" class="bg-white/20 px-4 py-2 rounded-lg">
                    <i class="fas fa-circle-notch fa-spin mr-2"></i>Conectando...
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <div class="container mx-auto px-4 py-6">
        <!-- Tabs -->
        <div class="bg-white rounded-lg shadow-md p-4 mb-6">
            <div class="flex space-x-2">
                <button onclick="mostrarTab('lista')" id="tab-lista" class="px-4 py-2 bg-purple-600 text-white rounded-lg">
                    <i class="fas fa-list mr-2"></i>Manifestações
                </button>
                <button onclick="mostrarTab('nova')" id="tab-nova" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg">
                    <i class="fas fa-plus mr-2"></i>Nova
                </button>
                <button onclick="mostrarTab('stats')" id="tab-stats" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg">
                    <i class="fas fa-chart-bar mr-2"></i>Estatísticas
                </button>
            </div>
        </div>

        <!-- Tab: Lista de Manifestações -->
        <div id="content-lista" class="tab-content">
            <div class="bg-white rounded-lg shadow-md p-6">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-2xl font-bold">Manifestações</h2>
                    <button onclick="carregarManifestacoes()" class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600">
                        <i class="fas fa-sync mr-2"></i>Atualizar
                    </button>
                </div>

                <!-- Filtros -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <input 
                        type="text" 
                        id="search-input" 
                        placeholder="Buscar por protocolo, assunto ou cidadão..."
                        class="px-4 py-2 border rounded-lg"
                        onkeyup="filtrarManifestacoes()"
                    >
                    <select id="status-filter" class="px-4 py-2 border rounded-lg" onchange="filtrarManifestacoes()">
                        <option value="">Todos os status</option>
                        <option value="Nova">Nova</option>
                        <option value="Em Análise">Em Análise</option>
                        <option value="Aguardando Setor">Aguardando Setor</option>
                        <option value="Respondida">Respondida</option>
                        <option value="Finalizada">Finalizada</option>
                    </select>
                </div>

                <div id="manifestacoes-lista" class="space-y-4">
                    <div class="text-center py-8">
                        <i class="fas fa-circle-notch fa-spin text-4xl text-purple-600"></i>
                        <p class="mt-4 text-gray-600">Carregando manifestações...</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tab: Nova Manifestação -->
        <div id="content-nova" class="tab-content hidden">
            <div class="bg-white rounded-lg shadow-md p-6 max-w-3xl mx-auto">
                <h2 class="text-2xl font-bold mb-6">Nova Manifestação</h2>
                <form id="form-nova" onsubmit="criarManifestacao(event)" class="space-y-4">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block font-medium mb-2">Tipo *</label>
                            <select name="tipo" required class="w-full px-4 py-2 border rounded-lg">
                                <option value="Reclamação">Reclamação</option>
                                <option value="Solicitação">Solicitação</option>
                                <option value="Denúncia">Denúncia</option>
                                <option value="Sugestão">Sugestão</option>
                                <option value="Elogio">Elogio</option>
                            </select>
                        </div>
                        <div>
                            <label class="block font-medium mb-2">Categoria *</label>
                            <select name="categoria" required class="w-full px-4 py-2 border rounded-lg">
                                <option value="">Selecione...</option>
                                <option value="Saúde">Saúde</option>
                                <option value="Educação">Educação</option>
                                <option value="Infraestrutura">Infraestrutura</option>
                                <option value="Meio Ambiente">Meio Ambiente</option>
                                <option value="Mobilidade">Mobilidade</option>
                                <option value="Segurança">Segurança</option>
                            </select>
                        </div>
                        <div class="md:col-span-2">
                            <label class="block font-medium mb-2">Assunto *</label>
                            <input type="text" name="assunto" required class="w-full px-4 py-2 border rounded-lg">
                        </div>
                        <div class="md:col-span-2">
                            <label class="block font-medium mb-2">Descrição *</label>
                            <textarea name="descricao" required rows="4" class="w-full px-4 py-2 border rounded-lg"></textarea>
                        </div>
                        <div>
                            <label class="block font-medium mb-2">Nome do Cidadão *</label>
                            <input type="text" name="cidadao" required class="w-full px-4 py-2 border rounded-lg">
                        </div>
                        <div>
                            <label class="block font-medium mb-2">Email</label>
                            <input type="email" name="email" class="w-full px-4 py-2 border rounded-lg">
                        </div>
                        <div>
                            <label class="block font-medium mb-2">Telefone</label>
                            <input type="tel" name="telefone" class="w-full px-4 py-2 border rounded-lg">
                        </div>
                        <div>
                            <label class="block font-medium mb-2">Canal *</label>
                            <select name="canal" required class="w-full px-4 py-2 border rounded-lg">
                                <option value="Portal Web">Portal Web</option>
                                <option value="Aplicativo">Aplicativo</option>
                                <option value="WhatsApp">WhatsApp</option>
                                <option value="Telefone">Telefone</option>
                                <option value="E-mail">E-mail</option>
                            </select>
                        </div>
                        <div>
                            <label class="block font-medium mb-2">Prioridade</label>
                            <select name="prioridade" class="w-full px-4 py-2 border rounded-lg">
                                <option value="Baixa">Baixa</option>
                                <option value="Média" selected>Média</option>
                                <option value="Alta">Alta</option>
                            </select>
                        </div>
                        <div>
                            <label class="block font-medium mb-2">Prazo Legal (dias)</label>
                            <input type="number" name="prazoLegal" value="20" class="w-full px-4 py-2 border rounded-lg">
                        </div>
                    </div>
                    <button type="submit" class="w-full bg-purple-600 text-white py-3 rounded-lg hover:bg-purple-700 font-medium">
                        <i class="fas fa-save mr-2"></i>Registrar Manifestação
                    </button>
                </form>
            </div>
        </div>

        <!-- Tab: Estatísticas -->
        <div id="content-stats" class="tab-content hidden">
            <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-6">
                <div class="bg-white rounded-lg shadow-md p-6">
                    <h3 class="text-gray-600 mb-2">Total</h3>
                    <p id="stat-total" class="text-3xl font-bold text-blue-600">0</p>
                </div>
                <div class="bg-white rounded-lg shadow-md p-6">
                    <h3 class="text-gray-600 mb-2">Novas</h3>
                    <p id="stat-novas" class="text-3xl font-bold text-yellow-600">0</p>
                </div>
                <div class="bg-white rounded-lg shadow-md p-6">
                    <h3 class="text-gray-600 mb-2">Respondidas</h3>
                    <p id="stat-respondidas" class="text-3xl font-bold text-green-600">0</p>
                </div>
                <div class="bg-white rounded-lg shadow-md p-6">
                    <h3 class="text-gray-600 mb-2">Finalizadas</h3>
                    <p id="stat-finalizadas" class="text-3xl font-bold text-gray-600">0</p>
                </div>
            </div>
            <div class="bg-white rounded-lg shadow-md p-6">
                <h3 class="text-xl font-bold mb-4">Distribuição por Status</h3>
                <div id="stats-status" class="space-y-2"></div>
            </div>
        </div>
    </div>

    <!-- Modal para Editar/Visualizar -->
    <div id="modal-detalhes" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50">
        <div class="bg-white rounded-lg shadow-2xl max-w-2xl w-full max-h-[90vh] overflow-y-auto m-4">
            <div class="gradient-bg text-white p-6 flex justify-between items-center">
                <h3 class="text-xl font-bold">Detalhes da Manifestação</h3>
                <button onclick="fecharModal()" class="text-white hover:bg-white/20 p-2 rounded">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            <div id="modal-content" class="p-6"></div>
        </div>
    </div>

    <script>
        const API_URL = 'http://localhost:3000/api';
        let todasManifestacoes = [];

        // Verificar conexão com backend
        async function verificarBackend() {
            try {
                const response = await fetch(`${API_URL}/manifestacoes`);
                if (response.ok) {
                    document.getElementById('status-backend').innerHTML = '<i class="fas fa-check-circle mr-2"></i>Backend Conectado';
                    document.getElementById('status-backend').classList.add('bg-green-500/30');
                    return true;
                }
            } catch (error) {
                document.getElementById('status-backend').innerHTML = '<i class="fas fa-exclamation-circle mr-2"></i>Backend Offline';
                document.getElementById('status-backend').classList.add('bg-red-500/30');
                return false;
            }
        }

        // Carregar manifestações
        async function carregarManifestacoes() {
            try {
                const response = await fetch(`${API_URL}/manifestacoes`);
                const data = await response.json();
                todasManifestacoes = data;
                renderizarManifestacoes(data);
            } catch (error) {
                document.getElementById('manifestacoes-lista').innerHTML = 
                    '<div class="text-center py-8 text-red-600"><i class="fas fa-exclamation-triangle text-4xl mb-4"></i><p>Erro ao carregar manifestações</p></div>';
            }
        }

        // Renderizar lista
        function renderizarManifestacoes(manifestacoes) {
            const lista = document.getElementById('manifestacoes-lista');
            if (manifestacoes.length === 0) {
                lista.innerHTML = '<div class="text-center py-8 text-gray-500">Nenhuma manifestação encontrada</div>';
                return;
            }

            lista.innerHTML = manifestacoes.map(m => `
                <div class="border rounded-lg p-4 hover:shadow-lg transition">
                    <div class="flex justify-between items-start mb-2">
                        <div class="flex-1">
                            <h3 class="font-bold text-lg">${m.assunto}</h3>
                            <p class="text-gray-600 text-sm">${m.descricao.substring(0, 100)}...</p>
                        </div>
                        <span class="status-badge bg-${getStatusColor(m.status)}-100 text-${getStatusColor(m.status)}-700">${m.status}</span>
                    </div>
                    <div class="flex flex-wrap gap-3 text-sm text-gray-500 mb-3">
                        <span><i class="fas fa-barcode mr-1"></i>${m.protocolo}</span>
                        <span><i class="fas fa-user mr-1"></i>${m.cidadao}</span>
                        <span><i class="fas fa-tag mr-1"></i>${m.categoria}</span>
                        <span><i class="fas fa-calendar mr-1"></i>${new Date(m.dataAbertura).toLocaleDateString('pt-BR')}</span>
                    </div>
                    <div class="flex space-x-2">
                        <button onclick="abrirModal(${m.id})" class="flex-1 bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">
                            <i class="fas fa-eye mr-2"></i>Visualizar
                        </button>
                        <button onclick="deletarManifestacao(${m.id})" class="bg-red-500 text-white px-4 py-2 rounded hover:bg-red-600">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            `).join('');
        }

        // Filtrar manifestações
        function filtrarManifestacoes() {
            const search = document.getElementById('search-input').value.toLowerCase();
            const status = document.getElementById('status-filter').value;

            const filtradas = todasManifestacoes.filter(m => {
                const matchSearch = !search || 
                    m.assunto.toLowerCase().includes(search) ||
                    m.protocolo.toLowerCase().includes(search) ||
                    m.cidadao.toLowerCase().includes(search);
                const matchStatus = !status || m.status === status;
                return matchSearch && matchStatus;
            });

            renderizarManifestacoes(filtradas);
        }

        // Criar nova manifestação
        async function criarManifestacao(event) {
            event.preventDefault();
            const form = event.target;
            const formData = new FormData(form);
            const data = Object.fromEntries(formData);

            try {
                const response = await fetch(`${API_URL}/manifestacoes`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                if (response.ok) {
                    const created = await response.json();
                    alert(`✅ Manifestação criada com sucesso!\n\nProtocolo: ${created.protocolo}`);
                    form.reset();
                    mostrarTab('lista');
                    carregarManifestacoes();
                    carregarEstatisticas();
                }
            } catch (error) {
                alert('❌ Erro ao criar manifestação');
            }
        }

        // Deletar manifestação
        async function deletarManifestacao(id) {
            if (!confirm('Tem certeza que deseja excluir esta manifestação?')) return;

            try {
                const response = await fetch(`${API_URL}/manifestacoes/${id}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    alert('✅ Manifestação excluída com sucesso!');
                    carregarManifestacoes();
                    carregarEstatisticas();
                }
            } catch (error) {
                alert('❌ Erro ao excluir manifestação');
            }
        }

        // Abrir modal
        async function abrirModal(id) {
            try {
                const response = await fetch(`${API_URL}/manifestacoes/${id}`);
                const m = await response.json();

                document.getElementById('modal-content').innerHTML = `
                    <div class="space-y-4">
                        <div class="grid grid-cols-2 gap-4 text-sm">
                            <div><strong>Protocolo:</strong> ${m.protocolo}</div>
                            <div><strong>Status:</strong> ${m.status}</div>
                            <div><strong>Tipo:</strong> ${m.tipo}</div>
                            <div><strong>Categoria:</strong> ${m.categoria}</div>
                            <div><strong>Prioridade:</strong> ${m.prioridade}</div>
                            <div><strong>Canal:</strong> ${m.canal}</div>
                        </div>
                        <div>
                            <strong>Cidadão:</strong> ${m.cidadao}
                            ${m.email ? `<br>Email: ${m.email}` : ''}
                            ${m.telefone ? `<br>Telefone: ${m.telefone}` : ''}
                        </div>
                        <div>
                            <strong>Assunto:</strong>
                            <p class="mt-1">${m.assunto}</p>
                        </div>
                        <div>
                            <strong>Descrição:</strong>
                            <p class="mt-1 bg-gray-50 p-3 rounded">${m.descricao}</p>
                        </div>
                        
                        <div class="border-t pt-4">
                            <label class="block font-medium mb-2">Atualizar Status:</label>
                            <select id="update-status" class="w-full px-4 py-2 border rounded mb-2">
                                <option value="Nova" ${m.status === 'Nova' ? 'selected' : ''}>Nova</option>
                                <option value="Em Análise" ${m.status === 'Em Análise' ? 'selected' : ''}>Em Análise</option>
                                <option value="Aguardando Setor" ${m.status === 'Aguardando Setor' ? 'selected' : ''}>Aguardando Setor</option>
                                <option value="Respondida" ${m.status === 'Respondida' ? 'selected' : ''}>Respondida</option>
                                <option value="Finalizada" ${m.status === 'Finalizada' ? 'selected' : ''}>Finalizada</option>
                            </select>

                            <label class="block font-medium mb-2">Resposta:</label>
                            <textarea id="update-resposta" class="w-full px-4 py-2 border rounded mb-2" rows="3">${m.resposta || ''}</textarea>

                            <label class="block font-medium mb-2">Responsável:</label>
                            <select id="update-responsavel" class="w-full px-4 py-2 border rounded mb-4">
                                <option value="">Selecione...</option>
                                <option ${m.responsavel === 'Secretaria de Saúde' ? 'selected' : ''}>Secretaria de Saúde</option>
                                <option ${m.responsavel === 'Secretaria de Educação' ? 'selected' : ''}>Secretaria de Educação</option>
                                <option ${m.responsavel === 'Secretaria de Obras' ? 'selected' : ''}>Secretaria de Obras</option>
                                <option ${m.responsavel === 'Secretaria de Meio Ambiente' ? 'selected' : ''}>Secretaria de Meio Ambiente</option>
                            </select>

                            <button onclick="atualizarManifestacao(${m.id})" class="w-full bg-purple-600 text-white py-2 rounded hover:bg-purple-700">
                                <i class="fas fa-save mr-2"></i>Salvar Alterações
                            </button>
                        </div>
                    </div>
                `;

                document.getElementById('modal-detalhes').classList.remove('hidden');
            } catch (error) {
                alert('❌ Erro ao carregar detalhes');
            }
        }

        // Atualizar manifestação
        async function atualizarManifestacao(id) {
            const data = {
                status: document.getElementById('update-status').value,
                resposta: document.getElementById('update-resposta').value,
                responsavel: document.getElementById('update-responsavel').value
            };

            try {
                const response = await fetch(`${API_URL}/manifestacoes/${id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                if (response.ok) {
                    alert('✅ Manifestação atualizada com sucesso!');
                    fecharModal();
                    carregarManifestacoes();
                    carregarEstatisticas();
                }
            } catch (error) {
                alert('❌ Erro ao atualizar manifestação');
            }
        }

        function fecharModal() {
            document.getElementById('modal-detalhes').classList.add('hidden');
        }

        // Carregar estatísticas
        async function carregarEstatisticas() {
            try {
                const response = await fetch(`${API_URL}/estatisticas`);
                const stats = await response.json();

                document.getElementById('stat-total').textContent = stats.total || 0;
                document.getElementById('stat-novas').textContent = stats.porStatus?.Nova || 0;
                document.getElementById('stat-respondidas').textContent = stats.porStatus?.Respondida || 0;
                document.getElementById('stat-finalizadas').textContent = stats.porStatus?.Finalizada || 0;

                // Distribuição por status
                const statusDiv = document.getElementById('stats-status');
                if (stats.porStatus) {
                    statusDiv.innerHTML = Object.entries(stats.porStatus).map(([status, count]) => `
                        <div class="flex justify-between items-center">
                            <span>${status}</span>
                            <span class="font-bold">${count}</span>
                        </div>
                    `).join('');
                }
            } catch (error) {
                console.error('Erro ao carregar estatísticas:', error);
            }
        }

        // Mostrar tabs
        function mostrarTab(tab) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
            document.querySelectorAll('[id^="tab-"]').forEach(el => {
                el.classList.remove('bg-purple-600', 'text-white');
                el.classList.add('bg-gray-200', 'text-gray-700');
            });

            document.getElementById(`content-${tab}`).classList.remove('hidden');
            document.getElementById(`tab-${tab}`).classList.remove('bg-gray-200', 'text-gray-700');
            document.getElementById(`tab-${tab}`).classList.add('bg-purple-600', 'text-white');

            if (tab === 'lista') carregarManifestacoes();
            if (tab === 'stats') carregarEstatisticas();
        }

        function getStatusColor(status) {
            const cores = {
                'Nova': 'blue',
                'Em Análise': 'yellow',
                'Aguardando Setor': 'orange',
                'Respondida': 'green',
                'Finalizada': 'gray'
            };
            return cores[status] || 'gray';
        }

        // Inicializar
        window.onload = () => {
            verificarBackend();
            carregarManifestacoes();
            carregarEstatisticas();
        };
    </script>
</body>
</html>
